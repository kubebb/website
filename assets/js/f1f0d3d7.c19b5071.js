"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[9889],{3905:(e,t,i)=>{i.d(t,{Zo:()=>u,kt:()=>m});var n=i(7294);function o(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function r(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function a(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?r(Object(i),!0).forEach((function(t){o(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):r(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function l(e,t){if(null==e)return{};var i,n,o=function(e,t){if(null==e)return{};var i,n,o={},r=Object.keys(e);for(n=0;n<r.length;n++)i=r[n],t.indexOf(i)>=0||(o[i]=e[i]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)i=r[n],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(o[i]=e[i])}return o}var c=n.createContext({}),s=function(e){var t=n.useContext(c),i=t;return e&&(i="function"==typeof e?e(t):a(a({},t),e)),i},u=function(e){var t=s(e.components);return n.createElement(c.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},k=n.forwardRef((function(e,t){var i=e.components,o=e.mdxType,r=e.originalType,c=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),p=s(i),k=o,m=p["".concat(c,".").concat(k)]||p[k]||d[k]||r;return i?n.createElement(m,a(a({ref:t},u),{},{components:i})):n.createElement(m,a({ref:t},u))}));function m(e,t){var i=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=i.length,a=new Array(r);a[0]=k;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l[p]="string"==typeof e?e:o,a[1]=l;for(var s=2;s<r;s++)a[s]=i[s];return n.createElement.apply(null,a)}return n.createElement.apply(null,i)}k.displayName="MDXCreateElement"},3294:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>d,frontMatter:()=>r,metadata:()=>l,toc:()=>s});var n=i(7462),o=(i(7294),i(3905));const r={sidebar_position:5},a="\u4f7f\u7528 kubelogin \u5de5\u5177",l={unversionedId:"component-market/kubelogin",id:"component-market/kubelogin",title:"\u4f7f\u7528 kubelogin \u5de5\u5177",description:"Here is the steps about how to install kubelogin to integrate with OIDC server for kubectl tool, so you can do authentication with Kubernetes.",source:"@site/docs/component-market/kubelogin.md",sourceDirName:"component-market",slug:"/component-market/kubelogin",permalink:"/website/docs/component-market/kubelogin",draft:!1,tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5},sidebar:"tutorialSidebar",previous:{title:"\u533a\u5757\u94fe - \u8054\u76df\u94fe",permalink:"/website/docs/component-market/blockchain"},next:{title:"\u5e38\u89c1\u95ee\u9898",permalink:"/website/docs/FAQ"}},c={},s=[{value:"Install kubelogin",id:"install-kubelogin",level:3},{value:"Prepare kubeconfig file",id:"prepare-kubeconfig-file",level:3},{value:"Get id token from cached file",id:"get-id-token-from-cached-file",level:3},{value:"Get id token using username/password",id:"get-id-token-using-usernamepassword",level:3},{value:"Logout",id:"logout",level:3}],u={toc:s},p="wrapper";function d(e){let{components:t,...i}=e;return(0,o.kt)(p,(0,n.Z)({},u,i,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"\u4f7f\u7528-kubelogin-\u5de5\u5177"},"\u4f7f\u7528 kubelogin \u5de5\u5177"),(0,o.kt)("p",null,"Here is the steps about how to install kubelogin to integrate with OIDC server for kubectl tool, so you can do authentication with Kubernetes."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Refer to ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/int128/kubelogin"},"kubelogin")," for details."),(0,o.kt)("li",{parentName:"ul"},"Prerequisite\nInstall u4a-component and it'll provide the account, authentication, authorization and audit funcationality built on Kubernetes.")),(0,o.kt)("h3",{id:"install-kubelogin"},"Install kubelogin"),(0,o.kt)("p",null,"Get the binary here ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/int128/kubelogin/releases"},"download")," and download the one matching your OS."),(0,o.kt)("p",null,"Then you need to put the kubelogin binary on your path under the name kubectl-oidc_login so that the kubectl plugin mechanism can find it when you invoke kubectl oidc-login."),(0,o.kt)("h3",{id:"prepare-kubeconfig-file"},"Prepare kubeconfig file"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Backup your original config file under ~/.kube/config and create a new one.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ cd ~/.kube\n$ cp config config_backup\n$ kubectl config set-credentials oidc \\\n      --exec-api-version=client.authentication.k8s.io/v1beta1 \\\n      --exec-command=kubectl \\\n      --exec-arg=oidc-login \\\n      --exec-arg=get-token \\\n      --exec-arg=--oidc-extra-scope=email \\\n      --exec-arg=--oidc-extra-scope=profile \\\n      --exec-arg=--oidc-issuer-url=https://portal.172.22.96.209.nip.io/oidc \\\n      --exec-arg=--oidc-client-id=bff-client \\\n      --exec-arg=--oidc-client-secret=61324af0-1234-4f61-b110-ef57013267d6 \\\n      --exec-arg=--insecure-skip-tls-verify\n")),(0,o.kt)("ol",{start:2},(0,o.kt)("li",{parentName:"ol"},"Point the cluster to kube-oidc-server or k8s-apiserver if oidc is enabled.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"- cluster:\n    certificate-authority-data: ....\n    server: https://172.22.96.133 # Update this value\n  name: cluster-name\n")),(0,o.kt)("ol",{start:3},(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Add ",(0,o.kt)("inlineCode",{parentName:"p"},"http://localhost:8000")," as a valid redirect URL of your OIDC server, so it can redirect to local server after successful login.")),(0,o.kt)("li",{parentName:"ol"},(0,o.kt)("p",{parentName:"li"},"Switch current context to oidc"))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"$ kubectl config set-context --current --user=oidc\n")),(0,o.kt)("p",null,"Run ",(0,o.kt)("inlineCode",{parentName:"p"},"kubectl get nodes"),", kubectl executes kubelogin before calling the Kubernetes APIs. Kubelogin automatically opens the browser, and you can log in to the provider."),(0,o.kt)("p",null,"After successful login, you'll get a ",(0,o.kt)("inlineCode",{parentName:"p"},"Authenticated")," response."),(0,o.kt)("ol",{start:5},(0,o.kt)("li",{parentName:"ol"},"If you get ",(0,o.kt)("inlineCode",{parentName:"li"},"Unable to connect to the server: x509: certificate signed by unknown authority")," error after ",(0,o.kt)("inlineCode",{parentName:"li"},"kubectl get nodes"),". Remove certificate-authority-data, and add insecure-skip-tls-verify as true.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"- cluster:\n    # certificate-authority-data: ....\n    server: https://172.22.96.133\n    insecure-skip-tls-verify: true # Add it here\n  name: cluster-name\n")),(0,o.kt)("p",null,"You can also use a valid certificate data, for example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"export CLUSTER_CA=$(kubectl get secret -n u4a-system oidc-proxy-cert-tls -o jsonpath='{.data.ca\\.crt}')\n# Use the data from CLUSTER_CA and set to certificate-authority-data\n")),(0,o.kt)("p",null,"Then you can run any kubectl using the logged in user, Kubernetes RBAC and audit will take effect for the user."),(0,o.kt)("h3",{id:"get-id-token-from-cached-file"},"Get id token from cached file"),(0,o.kt)("p",null,"The id_token will be cached in ~/.kube/cache/oidc-login/\\<cahced-file",">",", you can use ",(0,o.kt)("inlineCode",{parentName:"p"},"cat")," to get the content and token from this file. For example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'{"id_token":"eyJhbGciOiJSUzI1NiIsImtpZCI6IjBkMzEyM2U1MWIxN2IzZTNlNDYzNjgxZTMzZTFkOTNkM2RiY2IwZDkifQ.eyJpc3MiOiJodHRwczovL3BvcnRhbC4xNzIuMjIuOTYuMjA5Lm5pcC5pby9vaWRjIiwic3ViIjoiQ2dWaFpHMXBiaElHYXpoelkzSmsiLCJhdWQiOiJiZmYtY2xpZW50IiwiZXhwIjoxNjc0MzU3OTU0LCJpYXQiOjE2NzQyNzE1NTQsIm5vbmNlIjoiVHhJVlE4VlFINW9PTGtLeGV1ekk3VWp3VVU0WUYyOEQ1N18xLWVpVWEtVSIsImF0X2hhc2giOiJOamZKZWJ1Ry1uUlVlWDJNY2dfZzVRIiwiY19oYXNoIjoiQWVQdUtsTmN5RjgyTy1xWFFqUzEwdyIsImVtYWlsIjoiYWRtaW5AdGVueGNsb3VkLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJuYW1lIjoiYWRtaW4iLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJhZG1pbiIsInBob25lIjoiIiwidXNlcmlkIjoiYWRtaW4ifQ.YtmRZbS7-B0s0vVh9myH1FYcWuKoKNNYkPZQ5asbrQE2n8eC7w74n8D7pvM6v44kvBnp27hNOeo06EK4leNR2Inb2UJtd2QBS1L9i4A3V_vm06o4DkvqfyNcbD7-hL6ES0XkzIKimG3WMMJIznvuA71W_88t77U7jC7wvtKbT7k1KZWgOV6VappWlz7uecuBSQahoCku5AO-s25H1O-FbodOYtL8-ju0sqiHrgmbNaV-f6Wuvvk9XkquAe_dztqWCJ0axfUW7u4J-M947mlR1JlWwbhm-nQXgvugyMVh3FjFOjwi7jR3BA3Me-iuS_XPNSWx-DB0dfsCfErCJ9DvBA"}\n')),(0,o.kt)("h3",{id:"get-id-token-using-usernamepassword"},"Get id token using username/password"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Enable passwordConnector in the oidc-server configuration")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"# kubectl edit cm oidc-server -n u4a-system\n    oauth2:\n      # Enable this one\n      passwordConnector: k8scrd\n      skipApprovalScreen: true\n")),(0,o.kt)("ol",{start:2},(0,o.kt)("li",{parentName:"ol"},"Get id token using kubelogin or curl")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"kubelogin")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'kubelogin get-token --oidc-issuer-url=https://portal.172.22.96.209.nip.io/oidc --oidc-client-id=bff-client --oidc-client-secret=61324af0-1234-4f61-b110-ef57013267d6 --insecure-skip-tls-verify --grant-type=password --username=admin --password=admiN\\$123\n\n# here is the response, get the token from the json\n{"kind":"ExecCredential","apiVersion":"client.authentication.k8s.io/v1beta1","spec":{"interactive":false},"status":{"expirationTimestamp":"2023-02-11T04:37:32Z","token":"eyJhbGciOiJSUzI1NiIsImtpZCI6ImY2ZjFjMjFkNzFhOGEyYmU3ZTg2YjQyYWIwOTYwY2MxNzU3NjdiM2MifQ.eyJpc3MiOiJodHRwczovL3BvcnRhbC4xNzIuMjIuOTYuMjA5Lm5pcC5pby9vaWRjIiwic3ViIjoiQ2dWaFpHMXBiaElHYXpoelkzSmsiLCJhdWQiOiJiZmYtY2xpZW50IiwiZXhwIjoxNjc2MDkwMjUyLCJpYXQiOjE2NzYwMDM4NTIsImF0X2hhc2giOiJyLWtsUnBQcEd3U0I5TFQyelVQSWtRIiwicGhvbmUiOiIifQ.tFOmGN1w79I_s5pWZZK4zEEHwCyuJRwkNtacmxVcCY-Jms-JOzXUJTxnNm8XzIBC3cZqt5U6oNXMuk68MHq0v3g2tQKJeAwV1aojJrIIp5QHefXMUjl_hTaFe1tRgwsvZqBWhExLi1yaTSUfjmP_SZEb23A0R_AWvc7ClO7sbuKQlkPG_gi2TPCBOeTx0UmlQ14w6U3dIJhR57hXfttdSr2nRqKma8bp_jAiUiWaKLSWSyc3tQsxWl7LeAAbRM3URx-3winVIEPEpUgwIBXnrr-ba9BZwZoD5NGytOGw4xA80eGDmmMIG8U2QarJKsZErpzS7EWbiPBLgS2_Wg1eBA"}}\n')),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"curl")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'curl -k -XPOST https://portal.172.22.96.209.nip.io/oidc/token -H "Authorization: Basic <base64 of oidc-client-id:oidc-client-secret>" -H "Content-Type: application/x-www-form-urlencoded"  --data \'grant_type=password&password=password&scope=openid&username=username\'\n\n# here is the response, and get id_token from the json\n{"access_token":"eyJhbGciOiJSUzI1NiIsImtpZCI6ImY2ZjFjMjFkNzFhOGEyYmU3ZTg2YjQyYWIwOTYwY2MxNzU3NjdiM2MifQ.eyJpc3MiOiJodHRwczovL3BvcnRhbC4xNzIuMjIuOTYuMjA5Lm5pcC5pby9vaWRjIiwic3ViIjoiQ2dWaFpHMXBiaElHYXpoelkzSmsiLCJhdWQiOiJiZmYtY2xpZW50IiwiZXhwIjoxNjc2MDkyOTk0LCJpYXQiOjE2NzYwMDY1OTQsImF0X2hhc2giOiJtM2xsQWprUXdlQnhJbUJlQkgxRG1RIiwicGhvbmUiOiIifQ.iel5l_mzlVf2LjbMqzqXb3sqb7L195a-fY4Aaon2_CVn1lBMzOf2qDYbtVF3KhGHxNlaKRxig63uCDfyts84BMD5-Uaz_x4_mq5QaMVYVYEUw9NWsLP-jQ0bTSZE7MZKlxz_a3AGW_fXwW0Y02dqemugBfC3IagBhroYI2PSTKcNCCQz2aao-ZSQ5-rysKSyo0VPDtcY_K8ikpDChLM9GhUKzbdIvctO6mGBOOKHRkiCAbRegOCFhJ6-0O4k6b-m3rXyJkQAIBfesOPIAFxhQQhg3y9wDEVxbBTZ99fwfvfIuSxN_vsITKCsqpRr7t-30jqReIKsYktyzZ15jiJhKg","token_type":"bearer","expires_in":86399,"id_token":"eyJhbGciOiJSUzI1NiIsImtpZCI6ImY2ZjFjMjFkNzFhOGEyYmU3ZTg2YjQyYWIwOTYwY2MxNzU3NjdiM2MifQ.eyJpc3MiOiJodHRwczovL3BvcnRhbC4xNzIuMjIuOTYuMjA5Lm5pcC5pby9vaWRjIiwic3ViIjoiQ2dWaFpHMXBiaElHYXpoelkzSmsiLCJhdWQiOiJiZmYtY2xpZW50IiwiZXhwIjoxNjc2MDkyOTk0LCJpYXQiOjE2NzYwMDY1OTQsImF0X2hhc2giOiJRT3NNWGdSeDRYaUJJTVZwSElXeUlRIiwicGhvbmUiOiIifQ.ZDU7AouftfpLAs2SDE3Kb86ggVyDEwrgA3jtUxitKUQwKqosjWiaEEGc3w824FAC3eDZhFr1w5uXT6R30O2s0DPzPb0nesDN8wa2ZscU9ESjZrKAAgpgM7uE1vU41mi7GfdZEUHabx83XFvu69KvmA9OKnqaSdyi3-aPYHyBP5GfNYoQ-mteCBsAbRF8l6fe1VREIYV3sQrBC8b9s1Ony4F8YFWgFE4G_1gxV-0qz8IxgzhLGUgehuwsHTUjMLvyGgTiFrFvrPsftEuEGtOQbKswngWQGlYWSsUIWb79Fdk_-wD08fyM9YUGJyb0Bg_HO2M95CFsSASB4HDO4QHOXw"}\n')),(0,o.kt)("h3",{id:"logout"},"Logout"),(0,o.kt)("p",null,"You can remove the local cache files under ",(0,o.kt)("inlineCode",{parentName:"p"},"~/.kube/cache/oidc-login/<cached-file>")," to logout current user."))}d.isMDXComponent=!0}}]);